upstream flask_uwsgi {
    server blog_backend:8000;
    server blog_backend:8000;
    server blog_backend:8000;
}


log_format postdata '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent $request_body "$http_referer" "$http_user_agent" $http_x_forwarded_for';

server {
    listen 80;
    listen [::]:80;

    server_name foredge.cn www.foredge.cn;

    access_log  off;

    error_page 404 /custom_404.html;
    location = /custom_404.html {
        root /usr/share/nginx/html;
        internal;
    }

    # debug log
    #access_log /var/log/nginx/blog.access.log postdata;
    #error_log /var/log/nginx/blog.error.log;
    # debug log end

    gzip on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    keepalive_timeout 70;

    location ~ ^/ {
        include uwsgi_params;

        uwsgi_pass  flask_uwsgi;

        uwsgi_param REMOTE_ADDR $remote_addr;
        uwsgi_read_timeout 300;
    }

    location /static {
        root /opt/blog;
        access_log   off;
        expires      30d;
    }

    location /media {
        root /opt/blog;
        access_log   off;
        expires      30d;
    }

    location /robots.txt {
        alias /opt/blog/blog/robots.txt;
    }

}
